<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    
    <title>Rifa de Tarco - Para volver al ride</title>
    <style>
        :root { --libre: hsl(0, 0%, 94%); --pendiente: #ffd700; --pago: #4caf50; }
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f3; background-image: url('tarco.jpg'); background-size: cover; padding: 20px; text-align: center; }
        .grid-container { 
            display: grid; grid-template-columns: repeat(10, 1fr); 
            gap: 8px; max-width: 900px; margin: 20px auto; 
        }
        .casilla { 
            background: white;
            border: 1px solid #ddd;
            padding: 10px 5px;
            cursor: pointer;
            border-radius: 4px;
            transition: 0.2s;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;            
        }
        .casilla:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .nro { font-weight: bold; font-size: 1.2em; }
        .info { 
            max-width: 110px;
            max-height: 70px;
            margin-bottom: 5px;
            font-size: 0.75em;
            color: #555;
            /*word-wrap: break-word;*/
            overflow: hidden;
            text-overflow: ellipsis;
            /*overflow-wrap: anywhere;*/
        }
        .status-libre { border-top: 5px solid #ccc; background: #ffffffc7;}
        .status-pendiente { border-top: 5px solid var(--pendiente); background: #fffde7; }
        .status-pago { border-top: 5px solid var(--pago); background: #e8f5e9; }
        
        /* Modal */
        #modal, #overlay { display: none; position: fixed; z-index: 100; }
        #overlay { top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); }
        #modal { 
            top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: white; padding: 30px; border-radius: 12px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            width: 90vw; max-width: 600px;
            font-size: 20px;
        }
        /* Agrandar t√≠tulos e inputs dentro del modal */
        #modal h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
        }

        #modal label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        #modal input, 
        #modal select {
            width: 100%;
            padding: 15px;      /* M√°s espacio para tocar con el dedo */
            font-size: 1.2rem;  /* Letra grande y legible */
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box; /* Evita que el padding desborde el ancho */
        }

        /* Botones grandes para el pulgar */
        #modal button {
            width: 100%;
            padding: 18px;
            font-size: 1.3rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
        }

        input, select, button { width: 100%; margin: 8px 0; padding: 10px; box-sizing: border-box; }
        .btn-save { background: #2196f3; color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-export { background: #607d8b; color: white; width: auto; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        .valid-badge { font-size: 0.8em; color: #2196f3; }
        .no-valid { opacity: 0.6; border-style: dashed !important; }
        .admin-only { display: none; } /* Se mostrar√° con JS si es admin */
        .nav-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            gap: 10px;
        }
        .admin-buttons {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }
        /* Contenedor de estad√≠sticas */
        .stats-bar {
            display: flex;
            justify-content: space-around;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-item { display: flex; flex-direction: column; }
        .stat-value { font-size: 1.5em; color: #2196f3; }

        /* √çcono de advertencia para no validados */
        .casilla { position: relative; } /* Necesario para posicionar el √≠cono dentro */

        .warn-icon {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.8em;
            background: #ff9800;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Estilo para casilla no validada (m√°s sutil) */
        .no-valid {
            border: 2px dashed #ff9800 !important;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="nav-bar">
            <button id="btn-login" class="btn-export" onclick="login()">Log In Admin</button>
            <button id="btn-logout" class="btn-export" style="display:none; background:#f44336" onclick="logout()">Log Out</button>
            <div class="admin-only admin-buttons">
                <button class="btn-export" onclick="exportarJSON()">
                    üìä Descargar Respaldo
                </button>            
                <button class="btn-export" onclick="document.getElementById('import-input').click()" style="background: #607d8b">
                    üì• Restaurar Respaldo
                </button>
                <input type="file" id="import-input" style="display:none" accept=".json" onchange="procesarArchivo(this)">
                <button class="btn-export" onclick="exportarCSV()" style="background: #4caf50">üìä Reporte</button>
            </div>
        </div>

        <h1>Rifa de Jhon Tarquino</h1>
        <h2>--- Para volver al ride ---</h2>

        <div class="stats-bar">
            <div class="stat-item">
                <span>Libres</span>
                <span id="stat-libres" class="stat-value">0</span>
            </div>
            <div class="stat-item">
                <span>Por Validar</span>
                <span id="stat-por-validar" class="stat-value" style="color: #ff9800;">0</span>
            </div>
            <div class="stat-item">
                <span>Validados</span>
                <span id="stat-validados" class="stat-value" style="color: #4caf50;">0</span>
            </div>
            <div class="stat-item">
                <span>Pagados</span>
                <span id="stat-pagados" class="stat-value" style="color: var(--pago);">0</span>
            </div>
            <div class="stat-item">
                <span>Pendientes</span>
                <span id="stat-pendientes" class="stat-value" style="color: var(--pendiente)">0</span>
            </div>
        </div>

        <div class="grid-container" id="grid"></div>

    </div>

    <div id="overlay" onclick="cerrarModal()"></div>
    <div id="modal">
        <h2 id="m-titulo">Casilla</h2>
        <div id="public-fields">
            <label>Nombre del Participante:</label>
            <input type="text" id="m-nombre">
            <label>Tel√©fono de contacto:</label>
            <input type="text" id="m-telefono">
            <label>Estado:</label>
            <select id="m-status">
                <option value="libre">Libre</option>
                <option value="pendiente">Pendiente</option>
                <option value="pago">Pagado</option>
            </select>
            <label>Cobrado por / Pagado a:</label>
            <select id="m-cobrador">
                <option value="">-</option>
                <option value="David">David</option>
                <option value="Tarquino">Tarquino</option>
            </select>
        </div>
        <div class="admin-only" id="admin-fields">
            <label>
                <input type="checkbox" id="m-validado" style="width:auto"> Registro Validado
            </label>
        </div>

        <button class="btn-save" onclick="guardar()">Guardar Registro</button>
    </div>

    <script>
        let rifaData = {};
        let isAdmin = false;

        // Se ejecuta apenas carga la p√°gina
        window.onload = async () => {
            await checkAuth(); // Verifica si la cookie guardada es v√°lida
        };

        async function checkAuth() {
            try {
                const res = await fetch('/api/check-auth');
                const data = await res.json();
                isAdmin = data.isAdmin;
                
                // Actualizamos la interfaz seg√∫n el resultado
                actualizarInterfazAdmin(isAdmin);
            } catch (e) {
                console.error("Error verificando sesi√≥n");
            }
        }

        function actualizarInterfazAdmin(isAdmin) {
            // Mostrar/Ocultar elementos seg√∫n rol
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = isAdmin ? 'block' : 'none');
            document.getElementById('btn-login').style.display = isAdmin ? 'none' : 'block';
            document.getElementById('btn-logout').style.display = isAdmin ? 'block' : 'none';
        }

        async function login() {
            const pass = prompt("Contrase√±a de Administrador:");
            if (!pass) return;
            const res = await fetch('/api/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ pass })
            });
            if (res.ok) checkAuth();
            else alert("Contrase√±a incorrecta");
        }

        async function logout() {
            try {
                const res = await fetch('/api/logout', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                if (res.ok) {
                    isAdmin = false;
                    actualizarInterfazAdmin(isAdmin);
                    cargarDatos();                    
                } else {
                    alert("Error cerrando sesi√≥n")
                }
            } catch (e) {
                console.error("Error cerrando sesi√≥n");
            }
        }

        async function cargarDatos() {
            const res = await fetch('/api/rifa');
            const data = await res.json();
            rifaData = data;
            renderGrid();
        }

        function renderGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            // Contadores
            let libres = 0, porValidar = 0, validados = 0, pagados = 0, pendientes = 0;
            
            for(let i=0; i<100; i++) {
                const id = i.toString().padStart(2, '0');
                const d = rifaData[id] || { nombre: '', status: 'libre', validado: 0 };
                
                // L√≥gica de contadores
                if (d.status === 'libre') libres++;
                else if (d.validado === 0) porValidar++;
                else validados++;
                if (d.status === 'pendiente') pendientes++;
                else if (d.status === 'pago') pagados++;

                const div = document.createElement('div');
                // Si no est√° validado y no est√° libre, a√±adimos clase 'no-valid'
                const esNoValidado = d.status !== 'libre' && d.validado === 0;
                div.className = `casilla status-${d.status} ${esNoValidado ? 'no-valid' : ''}`;
                
                // Insertamos el √≠cono ‚ö†Ô∏è si est√° pendiente de validaci√≥n
                const iconHtml = esNoValidado ? `<div class="warn-icon" title="Pendiente de validar">!</div>` : '';
                
                div.innerHTML = `
                    ${iconHtml}
                    <div class="nro">${id}</div>
                    <div class="info" style="font-weight:bold">${d.nombre || '<span style="color:#ccc">Libre</span>'}</div>
                    <div class="info">${d.cobrador ? 'üí∞ '+d.cobrador : ''}</div>
                `;
                
                div.onclick = () => abrirModal(id);
                grid.appendChild(div);
            }

            // Actualizar panel de estad√≠sticas
            document.getElementById('stat-libres').innerText = libres;
            document.getElementById('stat-por-validar').innerText = porValidar;
            document.getElementById('stat-validados').innerText = validados;
            document.getElementById('stat-pagados').innerText = pagados;
            document.getElementById('stat-pendientes').innerText = pendientes;
        }

        let currentId = null;
        function abrirModal(id) {
            currentId = id;
            const d = rifaData[id] || { nombre: '', telefono: '', status: 'libre', cobrador: '', validado: 0 };
            
            document.getElementById('m-titulo').innerText = `N√∫mero #${id}`;
            document.getElementById('m-nombre').value = d.nombre || '';
            document.getElementById('m-telefono').value = d.telefono || '';
            document.getElementById('m-status').value = d.status;
            document.getElementById('m-cobrador').value = d.cobrador || '';

            if (isAdmin) {
                document.getElementById('m-validado').checked = d.validado === 1;
            }

            document.getElementById('modal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function cerrarModal() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        async function guardar() {
            const payload = {
                id: currentId,
                nombre: document.getElementById('m-nombre').value,
                telefono: document.getElementById('m-telefono').value,
                status: document.getElementById('m-status').value,
                cobrador: document.getElementById('m-cobrador').value,
                validado: isAdmin ? document.getElementById('m-validado').checked : 0 
            };
            
            const res = await fetch('/api/rifa', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });            
            const data = await res.json();
            
            if (res.status >= 400) {
                alert("‚ùå " + (data.error || 'No tienes permiso para modificar este registro.'));
            } else {
                cerrarModal();
                cargarDatos();
            }
        }

        function exportarCSV() {
            if (isAdmin) {
                window.location.href = `/api/export`;
            }
        }

        async function exportarJSON() {
            try {
                const res = await fetch('/api/export-json');
                if (!res.ok) throw new Error("No autorizado o error de servidor");

                const datos = await res.json();
                
                // Convertimos el objeto a una cadena de texto JSON con formato (indentaci√≥n de 2 espacios)
                const dataStr = JSON.stringify(datos, null, 2);
                
                // Creamos un "Blob" (un archivo virtual en memoria)
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                
                // Creamos un link temporal para forzar la descarga
                const link = document.createElement('a');
                const fecha = new Date().toISOString().split('T')[0]; // Ejemplo: 2026-01-15
                
                link.href = url;
                link.download = `reporte_rifa_${fecha}.json`;
                document.body.appendChild(link);
                link.click();
                
                // Limpiamos
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

            } catch (err) {
                alert("Error al exportar: " + err.message);
            }
        }

        async function procesarArchivo(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    
                    if (!confirm(`¬øEst√°s seguro de importar ${json.length} registros? Esto sobrescribir√° datos existentes.`)) return;

                    const res = await fetch('/api/import', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(json)
                    });

                    if (res.ok) {
                        alert("‚úÖ Importaci√≥n exitosa");
                        cargarDatos(); // Refrescar cuadr√≠cula
                    } else {
                        const err = await res.json();
                        alert("‚ùå Error: " + err.error);
                    }
                } catch (err) {
                    alert("‚ùå El archivo no es un JSON v√°lido");
                }
            };
            reader.readAsText(file);
            input.value = ''; // Limpiar input para permitir cargar el mismo archivo luego
        }

        cargarDatos();
        // Recarga autom√°tica cada 30 segundos para ver cambios de otros usuarios
        setInterval(cargarDatos, 30000);
    </script>
</body>
</html>